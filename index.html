<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario con Control de Acceso</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --admin-color: #4f46e5; --op-color: #0ea5e9; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        /* Login Simple */
        .login-box { text-align: center; padding: 40px; }
        .hidden { display: none !important; }
        
        /* Diseño */
        .header-ui { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .role-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; background: #f8fafc; padding: 20px; border-radius: 10px; }
        .input-group { display: flex; flex-direction: column; }
        .full-width { grid-column: 1 / -1; }
        label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }
        input, select, textarea { padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; }

        .actions { display: flex; gap: 10px; margin-bottom: 30px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-add { background: var(--op-color); color: white; }
        .btn-excel { background: #10b981; color: white; }
        .btn-logout { background: #64748b; color: white; flex: 0.2; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .stat-card { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; text-align: center; }
        .chart-wrapper { height: 300px; margin-top: 20px; }
    </style>
</head>
<body>

<div id="loginSection" class="container login-box">
    <h2>Sistema de Inventario</h2>
    <p>Ingresa la clave para acceder</p>
    <input type="password" id="passInput" placeholder="Clave de acceso" style="margin-bottom: 10px;"><br>
    <button onclick="login()" style="background: #4f46e5; color: white; max-width: 200px;">Entrar</button>
    <p style="font-size: 12px; color: #94a3b8; margin-top: 20px;">Admin: admin123 | Operador: op123</p>
</div>

<div id="mainSection" class="container hidden">
    <div class="header-ui">
        <h2>Panel de Inventario</h2>
        <div id="badge" class="role-badge"></div>
        <button class="btn-logout" onclick="logout()">Salir</button>
    </div>
    
    <div class="form-grid">
        <div class="input-group"><label>Pieza</label><input type="text" id="nombrePieza"></div>
        <div class="input-group"><label>Código</label><input type="text" id="codigoPieza"></div>
        <div class="input-group"><label>Factura</label><input type="text" id="numFactura"></div>
        <div class="input-group">
            <label>Estado</label>
            <select id="tipoPieza"><option value="Nueva">Nueva</option><option value="Repuesto">Repuesto</option></select>
        </div>
        <div class="input-group"><label>Cant.</label><input type="number" id="cantidad"></div>
        <div class="input-group"><label>Valor Unit.</label><input type="number" id="valor"></div>
        <div class="input-group full-width"><label>Descripción</label><textarea id="descripcion"></textarea></div>
    </div>
    <button class="btn-add" style="width: 100%; margin-bottom: 30px;" onclick="agregarDato()">Registrar Pieza</button>

    <div id="adminView" class="hidden">
        <div class="actions">
            <button class="btn-excel" onclick="exportarExcel()">Exportar Reporte Excel</button>
            <button onclick="limpiarTodo()" style="background: #ef4444; color: white;">Limpiar Todo</button>
        </div>
        <div class="chart-wrapper"><canvas id="miGrafica"></canvas></div>
        <h3 style="margin-top: 30px;">Comparativa Mensual</h3>
        <div id="statsGrid" class="stats-grid"></div>
    </div>
</div>

<script>
    let inventario = JSON.parse(localStorage.getItem('datosInventario')) || [];
    let currentUser = null;

    function login() {
        const pass = document.getElementById('passInput').value;
        const loginSec = document.getElementById('loginSection');
        const mainSec = document.getElementById('mainSection');
        const adminView = document.getElementById('adminView');
        const badge = document.getElementById('badge');

        if (pass === 'admin123') {
            currentUser = 'admin';
            adminView.classList.remove('hidden');
            badge.innerText = 'ADMINISTRADOR';
            badge.style.backgroundColor = '#4f46e5';
        } else if (pass === 'op123') {
            currentUser = 'operador';
            adminView.classList.add('hidden');
            badge.innerText = 'OPERADOR';
            badge.style.backgroundColor = '#0ea5e9';
        } else {
            return alert("Clave incorrecta");
        }

        loginSec.classList.add('hidden');
        mainSec.classList.remove('hidden');
        if(currentUser === 'admin') initChart();
        actualizarComparador();
    }

    function logout() { location.reload(); }

    // --- LÓGICA DE DATOS (Misma que antes) ---
    function agregarDato() {
        const ids = ['nombrePieza', 'codigoPieza', 'numFactura', 'tipoPieza', 'cantidad', 'valor', 'descripcion'];
        const v = ids.reduce((obj, id) => { obj[id] = document.getElementById(id).value; return obj; }, {});

        if (!v.nombrePieza || !v.cantidad || !v.valor) return alert("Faltan datos");

        const ahora = new Date();
        const registro = {
            Mes: ahora.toLocaleString('es-ES', { month: 'long' }),
            Fecha: ahora.toLocaleDateString(),
            Hora: ahora.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            Pieza: v.nombrePieza, Codigo: v.codigoPieza, Factura: v.numFactura,
            Estado: v.tipoPieza, Cantidad: parseInt(v.cantidad),
            Precio_Unit: parseFloat(v.valor), Total: parseInt(v.cantidad) * parseFloat(v.valor),
            Descripcion: v.descripcion
        };

        inventario.push(registro);
        localStorage.setItem('datosInventario', JSON.stringify(inventario));
        alert("¡Pieza registrada con éxito!");
        
        if (currentUser === 'admin') {
            actualizarGrafica(registro);
            actualizarComparador();
        }
        ids.forEach(id => document.getElementById(id).value = (id === 'tipoPieza' ? 'Nueva' : ''));
    }

    // --- FUNCIONES DE VISUALIZACIÓN ---
    let miGrafica;
    function initChart() {
        const ctx = document.getElementById('miGrafica').getContext('2d');
        miGrafica = new Chart(ctx, {
            type: 'line',
            data: {
                labels: inventario.map(d => d.Fecha + " " + d.Hora),
                datasets: [{
                    label: 'Gastos ($)',
                    data: inventario.map(d => d.Total),
                    borderColor: '#4f46e5',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function actualizarGrafica(reg) {
        if(!miGrafica) return;
        miGrafica.data.labels.push(reg.Fecha + " " + reg.Hora);
        miGrafica.data.datasets[0].data.push(reg.Total);
        miGrafica.update();
    }

    function actualizarComparador() {
        const grid = document.getElementById('statsGrid');
        if(!grid) return;
        grid.innerHTML = '';
        const totales = inventario.reduce((acc, curr) => {
            if (!acc[curr.Mes]) acc[curr.Mes] = 0;
            acc[curr.Mes] += curr.Total;
            return acc;
        }, {});
        for (const [mes, dinero] of Object.entries(totales)) {
            grid.innerHTML += <div class="stat-card"><div class="stat-month">${mes}</div><div class="stat-value">$${dinero.toLocaleString()}</div></div>;
        }
    }

    function exportarExcel() {
        const wb = XLSX.utils.book_new();
        const meses = [...new Set(inventario.map(r => r.Mes))];
        meses.forEach(mes => {
            const ws = XLSX.utils.json_to_sheet(inventario.filter(r => r.Mes === mes));
            XLSX.utils.book_append_sheet(wb, ws, mes.toUpperCase());
        });
        XLSX.writeFile(wb, "Reporte_Inventario.xlsx");
    }

    function limpiarTodo() {
        if(confirm("¿Borrar todo?")) { localStorage.removeItem('datosInventario'); location.reload(); }
    }
</script>
</body>
</html>
